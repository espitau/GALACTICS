#include "bliss.h"
#include "reduce.h"
#include "ntt.h"
#include "poly.h"

/* Roots of unity in F_q in bit-reversed order, for forward NTT */
static const uint32_t zetas[N] = {10952, 1106, 10620, 1638, 2892, 696,
    6772, 253, 5562, 4857, 1704, 971, 589, 10901, 2739, 7900, 7237,
    12093, 918, 5932, 6332, 810, 10000, 6333, 11770, 6606, 9187, 8228,
    5029, 3046, 6048, 10889, 2845, 4917, 169, 4171, 657, 872, 10462,
    1447, 7816, 8204, 7220, 11528, 3563, 9985, 9788, 10, 6807, 2862,
    6659, 5172, 10617, 9490, 946, 10477, 11215, 9124, 4165, 3246, 8702,
    3675, 1221, 11665, 7832, 7290, 3977, 7841, 8262, 4232, 10525, 8601,
    8394, 2836, 5276, 11978, 8949, 318, 10298, 4671, 5301, 12086, 73,
    9655, 3047, 8739, 6846, 11387, 9557, 2453, 9954, 12033, 11792, 2277,
    6264, 10839, 9530, 11676, 8514, 8270, 10775, 9681, 1180, 182, 4584,
    8497, 10989, 6673, 618, 4636, 8382, 9666, 7489, 3842, 2069, 90, 3535,
    5440, 102, 3390, 1521, 672, 7386, 11262, 8135, 734, 7848, 6376, 1130,
    12255, 2918, 2283, 1600, 6912, 7503, 12259, 10318, 9673, 5481, 7948,
    11782, 12065, 9827, 8535, 3222, 9495, 12083, 2551, 10761, 1264, 8626,
    1872, 5016, 8397, 9451, 5436, 4601, 9062, 3703, 8132, 1557, 4760,
    9306, 12183, 9491, 3151, 6434, 4200, 5582, 9859, 6867, 5579, 9535,
    6782, 588, 9422, 3613, 10201, 4262, 11530, 5007, 7375, 8971, 8278,
    10522, 4164, 4072, 878, 7177, 9376, 10007, 4397, 10826, 11376, 3900,
    4559, 10435, 10670, 11721, 7869, 4542, 7824, 8749, 11743, 11325,
    12057, 1839, 4012, 7726, 10273, 2420, 3081, 173, 10087, 1034, 5450,
    1684, 8258, 11983, 2119, 6082, 12019, 763, 10178, 8196, 4930, 7005,
    768, 1491, 5458, 5786, 4350, 3148, 10650, 4040, 2706, 12070, 7902,
    609, 3614, 12081, 11882, 5292, 11064, 358, 1055, 2708, 11207, 10020,
    11335, 5973, 10565, 8750, 933, 3781, 604, 2195, 2109, 10562, 1879,
    4848, 5705, 491, 1138, 8406, 8295, 5916, 12285, 9401, 5220, 1634,
    8042, 10500, 8493, 6995, 10556, 2252, 389, 1313, 265, 11266, 10819,
    6885, 7623, 10623, 6075, 1266, 4486, 12214, 11965, 8289, 7298, 9464,
    85, 4994, 437, 2904, 6155, 7412, 560, 11072, 6540, 4731, 4708, 4680,
    3013, 3820, 9129, 4234, 6985, 515, 12056, 8041, 9176, 6931, 1923,
    12038, 9730, 7095, 10988, 7979, 3501, 11817, 2385, 1510, 8981, 2703,
    3812, 9584, 5519, 11394, 3507, 520, 7162, 11348, 9207, 10875, 10113,
    2417, 10933, 4088, 12253, 921, 10369, 9035, 4622, 6692, 4823, 4419,
    10242, 2189, 5524, 1239, 1420, 4635, 10192, 9802, 8427, 2539, 7036,
    10030, 1547, 2410, 580, 934, 5018, 8850, 1365, 1336, 9704, 5712,
    5505, 5263, 5040, 6239, 10731, 867, 4237, 9373, 675, 8079, 3933, 765,
    847, 3577, 6113, 2342, 10609, 3651, 4958, 10385, 10454, 8475, 12034,
    9596, 10978, 12000, 2684, 972, 12064, 455, 9339, 3785, 6520, 753,
    7677, 3293, 3903, 11876, 3623, 10744, 699, 829, 9480, 3250, 1751,
    3069, 4410, 3923, 1709, 4998, 6353, 8491, 11120, 5533, 11122, 8350,
    11494, 3593, 5199, 11388, 6922, 10034, 7463, 10816, 8875, 5181, 6652,
    5962, 6585, 8664, 8918, 7387, 452, 6830, 12, 11982, 640, 6777, 7648,
    5059, 10549, 9487, 9524, 10317, 8194, 7461, 11586, 4672, 3470, 10673,
    6291, 8029, 3717, 9688, 11867, 8748, 10264, 341, 490, 9994, 9748,
    8789, 9458, 5861, 4674, 7442, 8063, 7755, 4008, 9762, 10712, 4502,
    10109, 11321, 6141, 5722, 8006, 25, 108, 9526, 5760, 5038, 4068,
    6528, 8047, 7759, 9924, 4180, 853, 1416, 5134, 1786, 11648, 10729,
    3092, 2823, 9246, 2685, 1768, 8021, 4174};

/* Roots of unity in order needed by inverse ntt */
static const uint32_t zetas_inv[N] = {8115, 4268, 10521, 9604, 3043,
    9466, 9197, 1560, 641, 10503, 7155, 10873, 11436, 8109, 2365, 4530,
    4242, 5761, 8221, 7251, 6529, 2763, 12181, 12264, 4283, 6567, 6148,
    968, 2180, 7787, 1577, 2527, 8281, 4534, 4226, 4847, 7615, 6428,
    2831, 3500, 2541, 2295, 11799, 11948, 2025, 3541, 422, 2601, 8572,
    4260, 5998, 1616, 8819, 7617, 703, 4828, 4095, 1972, 2765, 2802,
    1740, 7230, 4641, 5512, 11649, 307, 12277, 5459, 11837, 4902, 3371,
    3625, 5704, 6327, 5637, 7108, 3414, 1473, 4826, 2255, 5367, 901,
    7090, 8696, 795, 3939, 1167, 6756, 1169, 3798, 5936, 7291, 10580,
    8366, 7879, 9220, 10538, 9039, 2809, 11460, 11590, 1545, 8666, 413,
    8386, 8996, 4612, 11536, 5769, 8504, 2950, 11834, 225, 11317, 9605,
    289, 1311, 2693, 255, 3814, 1835, 1904, 7331, 8638, 1680, 9947, 6176,
    8712, 11442, 11524, 8356, 4210, 11614, 2916, 8052, 11422, 1558, 6050,
    7249, 7026, 6784, 6577, 2585, 10953, 10924, 3439, 7271, 11355, 11709,
    9879, 10742, 2259, 5253, 9750, 3862, 2487, 2097, 7654, 10869, 11050,
    6765, 10100, 2047, 7870, 7466, 5597, 7667, 3254, 1920, 11368, 36,
    8201, 1356, 9872, 2176, 1414, 3082, 941, 5127, 11769, 8782, 895,
    6770, 2705, 8477, 9586, 3308, 10779, 9904, 472, 8788, 4310, 1301,
    5194, 2559, 251, 10366, 5358, 3113, 4248, 233, 11774, 5304, 8055,
    3160, 8469, 9276, 7609, 7581, 7558, 5749, 1217, 11729, 4877, 6134,
    9385, 11852, 7295, 12204, 2825, 4991, 4000, 324, 75, 7803, 11023,
    6214, 1666, 4666, 5404, 1470, 1023, 12024, 10976, 11900, 10037, 1733,
    5294, 3796, 1789, 4247, 10655, 7069, 2888, 4, 6373, 3994, 3883,
    11151, 11798, 6584, 7441, 10410, 1727, 10180, 10094, 11685, 8508,
    11356, 3539, 1724, 6316, 954, 2269, 1082, 9581, 11234, 11931, 1225,
    6997, 407, 208, 8675, 11680, 4387, 219, 9583, 8249, 1639, 9141, 7939,
    6503, 6831, 10798, 11521, 5284, 7359, 4093, 2111, 11526, 270, 6207,
    10170, 306, 4031, 10605, 6839, 11255, 2202, 12116, 9208, 9869, 2016,
    4563, 8277, 10450, 232, 964, 546, 3540, 4465, 7747, 4420, 568, 1619,
    1854, 7730, 8389, 913, 1463, 7892, 2282, 2913, 5112, 11411, 8217,
    8125, 1767, 4011, 3318, 4914, 7282, 759, 8027, 2088, 8676, 2867,
    11701, 5507, 2754, 6710, 5422, 2430, 6707, 8089, 5855, 9138, 2798,
    106, 2983, 7529, 10732, 4157, 8586, 3227, 7688, 6853, 2838, 3892,
    7273, 10417, 3663, 11025, 1528, 9738, 206, 2794, 9067, 3754, 2462,
    224, 507, 4341, 6808, 2616, 1971, 30, 4786, 5377, 10689, 10006, 9371,
    34, 11159, 5913, 4441, 11555, 4154, 1027, 4903, 11617, 10768, 8899,
    12187, 6849, 8754, 12199, 10220, 8447, 4800, 2623, 3907, 7653, 11671,
    5616, 1300, 3792, 7705, 12107, 11109, 2608, 1514, 4019, 3775, 613,
    2759, 1450, 6025, 10012, 497, 256, 2335, 9836, 2732, 902, 5443, 3550,
    9242, 2634, 12216, 203, 6988, 7618, 1991, 11971, 3340, 311, 7013,
    9453, 3895, 3688, 1764, 8057, 4027, 4448, 8312, 4999, 4457, 624,
    11068, 8614, 3587, 9043, 8124, 3165, 1074, 1812, 11343, 2799, 1672,
    7117, 5630, 9427, 5482, 12279, 2501, 2304, 8726, 761, 5069, 4085,
    4473, 10842, 1827, 11417, 11632, 8118, 12120, 7372, 9444, 1400, 6241,
    9243, 7260, 4061, 3102, 5683, 519, 5956, 2289, 11479, 5957, 6357,
    11371, 196, 5052, 4389, 9550, 1388, 11700, 11318, 10585, 7432, 6727,
    12036, 5517, 11593, 9397, 10651, 1669, 11183, 1337};

void ntt(uint32_t p[N]) {
  unsigned int len, start, j, k;
  uint32_t zeta, t;

  k = 1;
  for(len = 256; len > 0; len >>= 1) {
    for(start = 0; start < N; start = j + len) {
      zeta = zetas[k++];
      for(j = start; j < start + len; ++j) {
        t = montgomery_reduce((uint64_t)zeta * p[j + len]);
        p[j + len] = p[j] + 2*Q - t;
        p[j] = p[j] + t;
      }
    }
  }
}

void invntt_frominvmont(uint32_t p[N]) {
  unsigned int start, len, j, k;
  uint32_t t, zeta;
  const uint32_t f = (((uint64_t)MONT*MONT % Q) * (Q-1) % Q) * ((Q-1) >> 9) % Q;

  k = 0;
  for(len = 1; len < N; len <<= 1) {
    for(start = 0; start < N; start = j + len) {
      zeta = zetas_inv[k++];
      for(j = start; j < start + len; ++j) {
        t = p[j];
        p[j] = t + p[j + len];
        p[j + len] = t + 512*Q - p[j + len];
        p[j + len] = montgomery_reduce((uint64_t)zeta * p[j + len]);
      }
    }
  }

  for(j = 0; j < N; ++j) {
    p[j] = montgomery_reduce((uint64_t)f * p[j]);
  }
}
